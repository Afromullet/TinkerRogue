# Combat Analysis Playbook

A reusable prompt/playbook for analyzing combat balance CSV reports generated by the TinkerRogue combat simulation pipeline. Paste this file along with a fresh `combat_balance_compressed.csv` into Claude to get a structured analysis.

---

## 1. CSV Format Reference

The CSV report has three sections, separated by blank lines and header comments.

### Section 1: Unit Overview

```
# Unit Overview
Unit,AttacksMade,AttacksReceived,OffHitRate,DefDodgeRate,OffCritRate,AvgDmgDealt,AvgDmgTaken,Kills,Deaths,KDRatio
```

| Column | Meaning |
|---|---|
| Unit | Unit type name |
| AttacksMade | Total attacks this unit made across all battles |
| AttacksReceived | Total attacks received |
| OffHitRate | Offensive hit rate (fraction 0-1, e.g. 0.90 = 90%) |
| DefDodgeRate | Defensive dodge rate (fraction 0-1) |
| OffCritRate | Offensive critical hit rate (fraction 0-1) |
| AvgDmgDealt | Average damage dealt per attack |
| AvgDmgTaken | Average damage taken per attack received |
| Kills | Total kills across all battles |
| Deaths | Total deaths across all battles |
| KDRatio | Kill/Death ratio (Kills / Deaths, 0.00 if 0 deaths would be infinity) |

### Section 2: Compressed Matchups

```
# Compressed Matchups
Attacker,Defender,TotalAttacks,HitRate,CritRate,DodgeRate,TotalDamage,AvgDmgPerAttack,Kills,BattlesSampled
```

| Column | Meaning |
|---|---|
| Attacker | Attacking unit type |
| Defender | Defending unit type |
| TotalAttacks | Number of attacks in this matchup |
| HitRate | Fraction of attacks that hit (0-1) |
| CritRate | Fraction of attacks that crit (0-1) |
| DodgeRate | Fraction of attacks dodged by defender (0-1) |
| TotalDamage | Sum of all damage dealt |
| AvgDmgPerAttack | TotalDamage / TotalAttacks |
| Kills | Kills scored by attacker in this matchup |
| BattlesSampled | Number of battles this matchup appeared in |

**Low BattlesSampled (1-2) means the data is noisy.** Weight matchups with more samples more heavily.

### Section 3: Balance Alerts

```
# Balance Alerts
AlertType,Subject,Value,Threshold,Details
```

| AlertType | What It Flags |
|---|---|
| HighCrit | Crit rate > 50% in a specific matchup |
| HighDamage | Average damage in top 5% of all matchups |
| PerfectHitRate | 100% hit rate in a matchup (never misses) |
| SkewedKD | Unit K/D ratio > 5.0 overall |

---

## 2. Analysis Steps

When given a new CSV, follow these steps in order:

### Step 1: Unit Tier List

Rank all units by composite performance. Consider:
- **K/D Ratio** (primary) — higher is better
- **AvgDmgDealt** — raw offensive output
- **Survivability** = Deaths relative to AttacksReceived (fewer deaths per attack received = tougher)

Assign tiers:
- **S Tier:** Dominant. K/D > 5.0 or clearly overperforming role expectations.
- **A Tier:** Strong. Performing above role targets.
- **B Tier:** Balanced. Within expected role ranges.
- **C Tier:** Weak. Below role targets but functional.
- **F Tier:** Broken/Nonfunctional. K/D near 0, no kills, or clearly bugged.

Present as a table with Unit, Role, K/D, AvgDmg, Deaths, and Tier.

### Step 2: Role Balance Check

Group units by role (Tank, DPS, Support) and check if they perform as expected:

- **Tanks** should: survive long (low deaths relative to attacks received), deal moderate damage, have K/D 0.5-1.5
- **DPS (Melee)** should: deal high damage, have K/D 1.5-3.0, moderate survivability
- **DPS (Ranged)** should: deal high damage, have K/D 1.0-2.5, low survivability
- **DPS (Magic)** should: deal the highest per-hit damage, K/D 1.5-3.0, low survivability
- **Support** should: not dominate kills (K/D 0.3-1.0), provide utility, medium survivability

Flag any unit whose performance contradicts its role (e.g., a Support with K/D > 5.0).

### Step 3: Damage Formula Audit

Compare magic vs physical damage output:
- **Physical damage** = Strength/2 + Weapon*2, resisted by Strength/4 + Armor*2
- **Magic damage** = Magic*3, resisted by Magic/2

Calculate theoretical damage for each unit and compare to observed AvgDmgDealt. Flag units where:
- Observed damage is much higher or lower than theoretical (targeting pattern advantage or disadvantage)
- One damage type systematically outperforms the other

### Step 4: Rate Sanity Check

Compare observed rates to theoretical expectations from the formulas:

| Rate | Formula | Cap |
|---|---|---|
| Hit Rate | BaseHitChance(80) + Dex*2 | 100% |
| Crit Chance | Dex/2 | 50% |
| Dodge Chance | Dex/3 | 30% |

For each unit, compute theoretical rates from their dexterity stat and compare to observed. Flag deviations > 5 percentage points (accounting for sample size — small samples naturally deviate more).

### Step 5: Matchup Outliers

From the Compressed Matchups section, identify:
- **100% kill rate matchups** (attacker always kills defender)
- **0 damage matchups** (attacker never damages defender)
- **Extreme avg damage** (> 30 per attack)
- **Extreme hit rate deviation** (100% hit or < 50% hit with sufficient sample size)

For each outlier, note BattlesSampled. Outliers with only 1 battle may be noise.

### Step 6: Balance Alert Triage

Categorize the Balance Alerts section by severity:

1. **Critical** — SkewedKD alerts (unit is fundamentally over/underpowered)
2. **High** — HighDamage alerts (damage formula or stat imbalance)
3. **Medium** — HighCrit alerts (may indicate dex scaling issues)
4. **Low** — PerfectHitRate alerts (often sample size artifacts with < 10 attacks)

Count alerts by type and identify which units appear most frequently.

### Step 7: Stat Correlation

Analyze which base attributes correlate with winning:
- Does higher Dex always mean higher K/D? (Dex gives hit rate + crit + dodge)
- Does Strength matter for survivability? (HP + physical resist)
- Is Magic stat the strongest predictor? (Magic*3 damage with only Magic/2 resist)
- Is any attribute irrelevant? (e.g., Leadership has no combat effect in simulations)

### Step 8: Recommendations

Provide specific, actionable tuning suggestions. Each recommendation must reference:
- The exact config file or JSON to edit
- The specific value to change
- The expected impact on the identified problem
- Which units or matchups it affects

---

## 3. Tuning Knobs Reference

### Config Files

| File | What It Controls |
|---|---|
| `assets/gamedata/monsterdata.json` | Unit base stats (strength, dex, magic, armor, weapon, etc.), attack types, target patterns, roles |
| `assets/gamedata/powerconfig.json` | Role multipliers (Tank=1.2, DPS=1.5, Support=1.0), ability power values, composition bonuses |
| `assets/gamedata/aiconfig.json` | AI positioning weights per role, threat calculation parameters |
| `config/config.go` | Combat constants (DefaultBaseHitChance=80, caps, CritDamageBonus=0.5) |

### Damage Formulas

**Physical Damage Path** (AttackType: MeleeRow, MeleeColumn, Ranged):
```
BaseDamage = Strength/2 + Weapon*2
Resistance = Defender.Strength/4 + Defender.Armor*2
FinalDamage = max(BaseDamage - Resistance, 1)
```

**Magic Damage Path** (AttackType: Magic):
```
BaseDamage = Magic*3
Resistance = Defender.Magic/2
FinalDamage = max(BaseDamage - Resistance, 1)
```

**Critical Hit:**
```
CritDamage = BaseDamage * 1.5  (before resistance)
```

**Cover Reduction** (applied after resistance):
```
FinalDamage = FinalDamage * (1.0 - TotalCoverReduction)
TotalCoverReduction = sum of cover values from units in front rows (capped at 1.0)
```

**Counterattack Penalties:**
```
Hit chance: -20% penalty
Damage: 50% multiplier (applied before resistance)
```

### Accuracy Formulas

```
HitRate    = min(80 + Dex*2, 100)     // BaseHitChance + dex scaling, capped at 100%
CritChance = min(Dex/2, 50)           // Integer division, capped at 50%
DodgeChance = min(Dex/3, 30)          // Integer division, capped at 30%
```

### Health Formula

```
MaxHealth = 20 + Strength*2
```

### Targeting Patterns

| AttackType | Targeting Logic |
|---|---|
| MeleeRow | Hits all units in front row (row 0), pierces to next row if empty |
| MeleeColumn | Hits all units in attacker's column, pierces to next column if empty |
| Ranged | Hits all units in same row as attacker, fallback to lowest-armor target |
| Magic | Hits specific cells defined in targetCells (no pierce) |

**targetCells** is a list of [row, col] pairs defining the AoE pattern. More cells = more targets hit per attack. This is the primary reason magic users can dominate: large targetCells patterns hit many units simultaneously.

### Key Unit Stats Quick Reference

| Unit | Role | STR | DEX | MAG | Armor | Weapon | AttackType | targetCells count |
|---|---|---|---|---|---|---|---|---|
| Knight | Tank | 14 | 25 | 0 | 10 | 8 | MeleeRow | 0 |
| Paladin | Support | 13 | 22 | 8 | 9 | 7 | MeleeRow | 0 |
| Fighter | Tank | 15 | 30 | 0 | 8 | 10 | MeleeColumn | 0 |
| Warrior | DPS | 12 | 28 | 0 | 7 | 9 | MeleeRow | 0 |
| Swordsman | DPS | 12 | 40 | 0 | 5 | 9 | MeleeColumn | 0 |
| Spearman | Tank | 13 | 32 | 0 | 6 | 8 | MeleeColumn | 0 |
| Rogue | DPS | 8 | 55 | 0 | 3 | 7 | Magic | 2 |
| Assassin | DPS | 9 | 60 | 0 | 2 | 8 | MeleeColumn | 0 |
| Scout | Support | 7 | 50 | 0 | 3 | 6 | Ranged | 0 |
| Archer | DPS | 6 | 45 | 0 | 2 | 7 | Ranged | 0 |
| Ranger | Support | 8 | 48 | 5 | 4 | 8 | Magic | 3 |
| Crossbowman | DPS | 10 | 38 | 0 | 5 | 9 | Ranged | 0 |
| Marksman | DPS | 7 | 52 | 0 | 2 | 8 | Ranged | 0 |
| Wizard | DPS | 10 | 20 | 15 | 3 | 2 | Magic | 6 |
| Sorcerer | DPS | 11 | 22 | 14 | 3 | 3 | Magic | 9 |
| Mage | Support | 12 | 18 | 13 | 4 | 2 | Magic | 5 |
| Cleric | Support | 8 | 24 | 12 | 4 | 4 | Magic | 6 |
| Priest | Support | 6 | 20 | 11 | 3 | 3 | Magic | 9 |
| Warlock | DPS | 5 | 26 | 13 | 2 | 4 | Magic | 4 |
| Battle Mage | Support | 11 | 28 | 10 | 5 | 6 | MeleeColumn | 0 |
| Orc Warrior | Tank | 17 | 24 | 0 | 8 | 11 | MeleeRow | 0 |
| Goblin Raider | DPS | 6 | 42 | 0 | 2 | 5 | MeleeRow | 0 |
| Ogre | Tank | 18 | 15 | 0 | 12 | 12 | Magic | 6 |
| Skeleton Archer | DPS | 5 | 35 | 3 | 1 | 5 | Magic | 9 |

---

## 4. Pipeline Commands

### Clean Previous Logs

Always delete old simulation logs before running a new simulation to avoid mixing data from different balance patches.

```cmd
del /Q simulation_logs\*.json
```

### Full Pipeline (bat script)

From the TinkerRogue directory:
```cmd
scripts\run_combat_pipeline.bat
```

This runs all three steps: simulate, generate balance report, compress report. The script cleans old logs automatically.

### Individual Steps (manual)

Run simulations (from project root):
```cmd
go run ./tools/combat_simulator
```

Generate balance CSV:
```cmd
go run ./tools/combat_balance --dir ./simulation_logs --output ./docs/combat_balance_report.csv
```

Compress report:
```cmd
go run ./tools/report_compressor --input ./docs/combat_balance_report.csv --output ./docs/combat_balance_compressed.csv
```

---

## 5. Target Balance Ranges (per Role)

### Role Performance Targets

| Role | K/D Range | Avg Damage | Survivability | Notes |
|---|---|---|---|---|
| Tank | 0.5 - 1.5 | Low-Medium | High (fewest deaths per attack received) | Should absorb hits, not dominate kills |
| DPS (Melee) | 1.5 - 3.0 | High | Medium | Trades survivability for damage |
| DPS (Ranged) | 1.0 - 2.5 | High | Low | Glass cannon, range advantage |
| DPS (Magic) | 1.5 - 3.0 | Highest per-hit | Low | AoE advantage but fragile |
| Support | 0.3 - 1.0 | Low | Medium | Utility role, not damage |

### Rate Targets

| Rate | Target Range | Formula Basis |
|---|---|---|
| Hit Rate | 85% - 95% | BaseHitChance=80 + Dex scaling. Most units have Dex >= 15, so 80+30=100 capped. Low-dex units (Ogre: Dex 15) hit at 80+30=100 capped. |
| Dodge Rate | 5% - 20% | Dex/3. Most units fall in 5-17 range. High-dex specialists (Rogue: 55/3=18, Assassin: 60/3=20) at the top. |
| Crit Rate | 10% - 25% | Dex/2. Normal range. Crit-focused units (Marksman: 52/2=26, Rogue: 55/2=27, Assassin: 60/2=30) can reach 25-30%. |

### Flag Conditions

Flag a unit for review if any of these are true:
- K/D > 5.0 or K/D < 0.1 (except Supports which can be 0.1-0.3)
- AvgDmgDealt > 30 for non-magic units
- AvgDmgDealt > 40 for magic units
- Deaths = 0 with > 5 battles (immortal unit)
- Kills = 0 with > 5 battles (nonfunctional unit)
- Hit rate < 80% or > 98% (formula should floor at ~80%)
- Dodge rate > 25% (approaching cap)
- Crit rate > 35% (approaching cap)

---

## 6. Current Baseline Analysis (Worked Example)

*Based on `docs/combat_balance_compressed.csv` as of 2026-02-12.*

This section serves as the reference point for future comparisons. After making stat changes and regenerating the CSV, compare new values against this baseline to verify the intended effect.

### Step 1: Unit Tier List

| Unit | Role | K/D | AvgDmg | Deaths | Tier | Notes |
|---|---|---|---|---|---|---|
| Sorcerer | DPS | 67.50 | 35.16 | 2 | S (Broken-OP) | 135 kills, 2 deaths. Massively overtuned. |
| Mage | Support | 23.00 | 31.06 | 3 | S (Broken-OP) | 69 kills, 3 deaths. Support dealing top-tier damage. |
| Priest | Support | 7.00 | 26.18 | 11 | S (Overtuned) | 77 kills as a Support unit. |
| Spearman | Tank | 3.36 | 7.43 | 14 | A | Good survivability, slightly above Tank target. |
| Orc Warrior | Tank | 2.91 | 16.54 | 22 | A | Strong tank with high damage for role. |
| Fighter | Tank | 2.46 | 11.88 | 28 | A | Slightly above Tank K/D target. |
| Wizard | DPS | 1.84 | 39.32 | 63 | B+ | High damage but dies enough to balance. Near DPS target. |
| Swordsman | DPS | 1.39 | 9.82 | 54 | B | In range for melee DPS. |
| Knight | Tank | 1.39 | 8.61 | 46 | B | Within Tank targets. |
| Cleric | Support | 1.28 | 27.29 | 39 | B- (Overtuned) | K/D above Support target. Very high damage for Support. |
| Warrior | DPS | 1.26 | 9.81 | 61 | B- | Below melee DPS target K/D. |
| Paladin | Support | 1.11 | 6.82 | 61 | B | Near top of Support range. |
| Scout | Support | 0.89 | 5.36 | 36 | B | Within Support targets. |
| Battle Mage | Support | 0.67 | 5.47 | 33 | B | Within Support targets. |
| Crossbowman | DPS | 0.54 | 8.66 | 65 | C | Underperforming for DPS. |
| Skeleton Archer | DPS | 0.51 | 5.55 | 71 | C | Weak DPS despite magic targeting. |
| Assassin | DPS | 0.49 | 8.08 | 47 | C | Far below DPS target K/D despite highest dex. |
| Marksman | DPS | 0.30 | 6.53 | 74 | C | Very weak for DPS role. |
| Goblin Raider | DPS | 0.27 | 3.84 | 90 | F | Extremely low damage, dies constantly. |
| Archer | DPS | 0.26 | 6.51 | 89 | F | Too many deaths for output. |
| Ranger | Support | 0.25 | 11.57 | 60 | C- | Below Support target, too many deaths. |
| Warlock | DPS | 0.09 | 29.13 | 104 | F | Very high per-hit damage but 104 deaths. Only 30 attacks made. |
| Ogre | Tank | 0.05 | 0.87 | 20 | F (Broken) | 1 kill total. 0.87 avg damage. Something is very wrong. |
| Rogue | DPS | 0.00 | 1.00 | 60 | F (Broken) | 0 kills, 3 attacks total. Nonfunctional. |

### Step 2: Role Balance Check

**Tanks (Knight, Fighter, Spearman, Orc Warrior, Ogre):**
- Knight (1.39), Fighter (2.46), Spearman (3.36), Orc Warrior (2.91) are performing above Tank K/D targets (0.5-1.5). Fighter/Spearman/Orc are more like DPS in practice.
- **Ogre is completely broken** — 0.87 avg damage with 12 Weapon and 18 Strength. The Ogre uses AttackType "Magic" but has 0 Magic stat, so MagicDamage = 0*3 = 0, reduced to minimum 1. This is the root cause.

**DPS (Melee: Warrior, Swordsman, Assassin, Goblin Raider):**
- Warrior (1.26) and Swordsman (1.39) are slightly below target (1.5-3.0).
- Assassin (0.49) is far below despite 60 Dex. Armor/weapon too low.
- Goblin Raider (0.27) is far below. Str 6, Weapon 5 gives PhysicalDamage = 3+10 = 13, which is low.

**DPS (Ranged: Archer, Crossbowman, Marksman):**
- All underperforming (0.26, 0.54, 0.30). Ranged physical units have low Strength/Weapon, and their damage gets absorbed by armor.

**DPS (Magic: Wizard, Sorcerer, Warlock, Skeleton Archer):**
- Sorcerer (67.50 K/D) and Wizard (1.84 K/D) show the magic AoE advantage.
- Sorcerer targets ALL 9 cells — it hits the entire enemy squad every attack.
- Warlock (0.09 K/D) is broken in the opposite direction — too fragile (Str 5, Armor 2) and only 30 attacks total.
- Skeleton Archer (0.51 K/D) has 9 targetCells but Magic=3 giving only 9 magic damage before resistance.

**Support (Paladin, Mage, Cleric, Priest, Scout, Battle Mage, Ranger):**
- **Mage (23.00 K/D) and Priest (7.00 K/D) are massively overperforming.** These are Support units dealing top-tier damage via magic AoE.
- Cleric (1.28 K/D) is slightly above target.
- Paladin, Scout, Battle Mage are within range.
- Ranger (0.25 K/D) is underperforming.

### Step 3: Damage Formula Audit

**Physical vs Magic comparison (theoretical base damage, no crit/cover):**

Top physical damage units:
- Orc Warrior: 17/2 + 11*2 = 8 + 22 = **30** physical damage
- Fighter: 15/2 + 10*2 = 7 + 20 = **27** physical damage
- Warrior: 12/2 + 9*2 = 6 + 18 = **24** physical damage

Top magic damage units:
- Wizard: 15*3 = **45** magic damage
- Sorcerer: 14*3 = **42** magic damage
- Mage: 13*3 = **39** magic damage
- Warlock: 13*3 = **39** magic damage
- Cleric: 12*3 = **36** magic damage

**Resistance comparison:**
- Average physical resist (typical): ~10-20 (Str/4 + Armor*2)
- Average magic resist: ~0-7 (Magic/2, most physical units have Magic=0)

**Conclusion: Magic damage is fundamentally stronger.** Magic base damage is higher (39-45 vs 24-30) AND most defenders have near-zero magic resistance. Physical attackers hit into 10-20 resist; magic attackers hit into 0-7 resist. Combined with AoE targeting (hitting 5-9 units per attack), magic units get 3-9x the damage application of single-target physical attacks.

### Step 4: Rate Sanity Check

| Unit | Dex | Theoretical Hit | Observed Hit | Theoretical Crit | Observed Crit | Theoretical Dodge | Observed Dodge |
|---|---|---|---|---|---|---|---|
| Assassin | 60 | 100% | 92.1% | 30% | 27.5% | 20% | 17.3% |
| Rogue | 55 | 100% | 100% | 27% | 33.3% | 18% | 16.2% |
| Marksman | 52 | 100% | 87.2% | 26% | 25.5% | 17% | 15.0% |
| Scout | 50 | 100% | 87.2% | 25% | 21.6% | 16% | 21.9% |
| Ranger | 48 | 100% | 92.0% | 24% | 19.0% | 16% | 12.4% |
| Archer | 45 | 100% | 93.4% | 22% | 19.7% | 15% | 16.1% |
| Goblin Raider | 42 | 100% | 90.0% | 21% | 19.2% | 14% | 13.8% |
| Swordsman | 40 | 100% | 90.2% | 20% | 18.7% | 13% | 10.8% |
| Crossbowman | 38 | 100% | 88.4% | 19% | 18.3% | 12% | 10.6% |
| Skeleton Arch. | 35 | 100% | 91.3% | 17% | 16.7% | 11% | 7.7% |
| Spearman | 32 | 94% | 89.1% | 16% | 14.4% | 10% | 13.2% |
| Fighter | 30 | 100% | 90.3% | 15% | 15.4% | 10% | 7.4% |
| Warrior | 28 | 100% | 90.3% | 14% | 12.7% | 9% | 11.4% |
| Battle Mage | 28 | 100% | 90.2% | 14% | 16.0% | 9% | 9.8% |
| Warlock | 26 | 100% | 83.3% | 13% | 13.3% | 8% | 8.8% |
| Knight | 25 | 100% | 91.5% | 12% | 10.3% | 8% | 8.4% |
| Cleric | 24 | 100% | 87.2% | 12% | 12.1% | 8% | 8.8% |
| Orc Warrior | 24 | 100% | 88.8% | 12% | 11.2% | 8% | 8.0% |
| Sorcerer | 22 | 100% | 89.8% | 11% | 11.4% | 7% | 9.9% |
| Paladin | 22 | 100% | 87.9% | 11% | 10.4% | 7% | 7.3% |
| Wizard | 20 | 100% | 90.1% | 10% | 11.5% | 6% | 6.0% |
| Priest | 20 | 100% | 88.3% | 10% | 5.8% | 6% | 2.9% |
| Mage | 18 | 100% | 90.8% | 9% | 10.3% | 6% | 4.4% |
| Ogre | 15 | 100% | 87.3% | 7% | 8.1% | 5% | 4.5% |

**Notable:** All units with Dex >= 10 should have 100% theoretical hit rate (80 + 10*2 = 100), yet observed rates are 83-93%. This is explained by **counterattacks** — which apply a -20% hit penalty — being mixed into the aggregate stats. The gap between theoretical and observed hit rate reflects how often a unit counterattacks vs initiates.

Crit and dodge rates are generally close to theoretical, with expected statistical noise from sample sizes.

### Step 5: Matchup Outliers

**Extreme Damage Matchups (AvgDmg > 30):**
- Wizard vs Swordsman: 46.57 avg dmg (14 attacks, 14 kills on 5 battles)
- Wizard vs Fighter: 41.95 avg dmg (20 attacks, 9 kills)
- Sorcerer vs Rogue: 42.00 avg dmg (10 attacks, 9 kills)
- Sorcerer vs Swordsman: 40.38 avg dmg (13 attacks, 3 kills on 6 battles)
- Mage vs Crossbowman: 41.11 avg dmg (9 attacks, 1 kill)
- Cleric vs Goblin Raider: 39.00 avg dmg (6 attacks, 6 kills)

These are all magic attackers hitting low-magic-resist defenders. Consistent pattern.

**Nonfunctional Matchups:**
- Rogue only has 1 matchup row: Rogue vs Orc Warrior (6 attacks, 0 kills, 1.00 avg dmg). Rogue uses Magic attack type with 0 Magic stat, so MagicDamage = 0, floored to 1.
- Ogre vs all matchups: 0.50-1.05 avg damage across all defenders. Same issue — Magic attack type with 0 Magic.

**100% Hit Rate matchups:** 62 matchups flagged. Many have low sample sizes (< 10 attacks). The ones with more attacks (Fighter vs Wizard: 23 attacks at 100%) suggest that some attacker-defender combinations never produce misses or dodges.

### Step 6: Balance Alert Triage

**Critical (3 alerts):**
- SkewedKD: Sorcerer K/D = 67.50
- SkewedKD: Mage K/D = 23.00
- SkewedKD: Priest K/D = 7.00

**High (23 alerts):**
- HighDamage: 12 Sorcerer matchups, 10 Wizard matchups, 1 Warlock matchup, 1 Mage matchup, 1 Cleric matchup. Almost entirely magic users.

**Medium (2 alerts):**
- HighCrit: Assassin vs Marksman (66.7%), Marksman vs Skeleton Archer (55.6%). Both high-dex attackers against defenders, small sample sizes.

**Low (46 alerts):**
- PerfectHitRate: 46 matchups. Most have < 15 attacks. Likely sample size artifacts.

**Most-flagged units:** Sorcerer (15 alerts), Wizard (11 alerts), Mage (2 alerts).

### Step 7: Stat Correlation

**Magic stat is the dominant predictor of combat success.** The top 3 K/D units (Sorcerer, Mage, Priest) are all magic users. This is because:
1. Magic*3 produces higher base damage than physical formulas
2. Most units have 0 Magic, so magic resist is 0 for 16 of 24 units
3. Magic AoE (targetCells) hits multiple units per attack, multiplying total damage output

**Dexterity has diminishing returns.** High-dex units (Assassin=60, Rogue=55, Marksman=52) do NOT dominate because:
- Hit rate caps at 100% (reached at Dex=10)
- Crit and dodge provide marginal benefits that don't compensate for low base damage
- Dex doesn't contribute to physical damage at all

**Strength matters for survivability** (HP = 20 + Str*2) but its damage contribution is minor (Str/2).

**Leadership has no combat effect** in the simulator — it affects squad capacity only. High-leadership units (Paladin=60, Knight=50, Skeleton Archer=50) get no combat benefit.

### Step 8: Recommendations

1. **Fix Ogre and Rogue attack types.** Both use `AttackType: "Magic"` but have 0 Magic stat, making them deal minimum 1 damage.
   - **File:** `assets/gamedata/monsterdata.json`
   - **Change:** Set Ogre's attackType to `"MeleeRow"` (matches Tank role) or give it a Magic stat. Set Rogue's attackType to `"MeleeColumn"` or give it Magic.
   - **Impact:** Ogre would deal 18/2 + 12*2 = 33 physical damage instead of 1. Rogue would deal 8/2 + 7*2 = 18 physical damage instead of 1.

2. **Reduce magic damage scaling or increase magic resistance.**
   - **Option A:** Change magic damage formula in `common/commoncomponents.go` from `Magic*3` to `Magic*2`.
   - **Option B:** Give all units a base magic resistance (e.g., add `BaseMagicResist` constant to `config/config.go`).
   - **Option C:** Reduce targetCells count for Sorcerer (9 cells = entire grid) and Priest (9 cells).
   - **Impact:** Reducing Magic*3 to Magic*2 would bring Sorcerer from 42 to 28 base damage, Wizard from 45 to 30, bringing them closer to physical damage parity.

3. **Reduce Sorcerer targetCells from 9 to 4-5.**
   - **File:** `assets/gamedata/monsterdata.json`
   - **Change:** Sorcerer's targetCells from all 9 grid cells to a smaller pattern.
   - **Impact:** Cuts total damage application by ~50%, bringing K/D from 67.5 toward the 2-3 range.

4. **Reclassify Mage and Priest roles or reduce their damage.**
   - They are tagged as "Support" but deal more damage than any DPS unit.
   - **Option A:** Reduce their Magic stat (Mage 13->8, Priest 11->7).
   - **Option B:** Reduce targetCells count.
   - **Impact:** Brings them closer to Support K/D target of 0.3-1.0.

5. **Buff physical ranged DPS** (Archer, Crossbowman, Marksman).
   - **File:** `assets/gamedata/monsterdata.json`
   - **Change:** Increase Weapon stat by 2-3 for ranged units.
   - **Impact:** Archer damage goes from 6/2+7*2=17 to 6/2+9*2=21, helping compete with magic damage.

6. **Consider adding Dex->Damage scaling for high-dex melee units.**
   - Currently Dex gives hit/crit/dodge but no damage. Assassin (60 Dex) deals 9/2+8*2=20 physical damage, same tier as much slower units.
   - **File:** `common/commoncomponents.go`, `GetPhysicalDamage()` method.
   - **Possible change:** `Strength/2 + Weapon*2 + Dexterity/6` (small bonus).
   - **Impact:** Assassin gets +10 damage, making high-Dex builds viable.

### Baseline Values for Future Comparison

Record these values and compare after changes:

| Unit | Baseline K/D | Baseline AvgDmg | Target K/D | Priority |
|---|---|---|---|---|
| Sorcerer | 67.50 | 35.16 | 1.5-3.0 | Fix immediately |
| Mage | 23.00 | 31.06 | 0.3-1.0 | Fix immediately |
| Priest | 7.00 | 26.18 | 0.3-1.0 | Fix immediately |
| Rogue | 0.00 | 1.00 | 1.5-3.0 | Fix immediately (broken) |
| Ogre | 0.05 | 0.87 | 0.5-1.5 | Fix immediately (broken) |
| Warlock | 0.09 | 29.13 | 1.5-3.0 | High priority |
| Goblin Raider | 0.27 | 3.84 | 1.5-3.0 | Medium priority |
| Archer | 0.26 | 6.51 | 1.0-2.5 | Medium priority |
| Marksman | 0.30 | 6.53 | 1.0-2.5 | Medium priority |
| Assassin | 0.49 | 8.08 | 1.5-3.0 | Medium priority |
